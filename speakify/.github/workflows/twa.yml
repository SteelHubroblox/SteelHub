name: Build TWA and Deploy Pages

on:
  workflow_dispatch:

jobs:
  build-twa:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      STORE_PASS: speakifyStore123
      KEY_PASS: speakifyKey123
      KEY_ALIAS: speakify
      APP_NAME: Speakify
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Bubblewrap
        run: npm i -g @bubblewrap/cli

      - name: Init TWA project (from local manifest)
        run: |
          rm -rf twa
          yes "" | bubblewrap init --manifest manifest.webmanifest --directory twa --skipSigning || true

      - name: Generate upload keystore
        run: |
          keytool -genkeypair -v -keystore twa/android/app/upload.keystore \
            -alias "$KEY_ALIAS" -keyalg RSA -keysize 2048 -validity 36500 \
            -storepass "$STORE_PASS" -keypass "$KEY_PASS" \
            -dname "CN=$APP_NAME,O=$APP_NAME,L=City,ST=State,C=US"

      - name: Create keystore.properties
        run: |
          cat > twa/android/app/keystore.properties <<EOF
          storeFile=upload.keystore
          storePassword=$STORE_PASS
          keyAlias=$KEY_ALIAS
          keyPassword=$KEY_PASS
          EOF

      - name: Build APK (release) and AAB (release)
        run: |
          cd twa/android
          ./gradlew --no-daemon assembleRelease bundleRelease

      - name: Copy APK/AAB to repo folder
        run: |
          mkdir -p android-apk
          cp -a twa/android/app/build/outputs/apk/release/*.apk android-apk/ || true
          cp -a twa/android/app/build/outputs/bundle/release/*.aab android-apk/ || true

      - name: Commit APK/AAB to new branch apk-builds
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BR=apk-builds
          git checkout -B "$BR"
          git add android-apk/
          git commit -m "chore(build): add latest APK/AAB [skip ci]" || echo "No changes to commit"
          git push -f "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" "$BR"

      - name: Upload artifacts (fallback)
        uses: actions/upload-artifact@v4
        with:
          name: speakify-android-artifacts
          path: |
            android-apk/*.apk
            android-apk/*.aab